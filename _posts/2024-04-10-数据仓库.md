---
layout: post
title: 数据仓库
tags: [数据仓库]
categories: Demo
excerpt_separator: <!--more-->
---

数据仓库
<!--more-->

## 数据仓库

### 数仓分层

数据仓库和其他数据集合、数据库的区别，主要在于数据模型的建立和使用。数据仓库需要将数据按照不同的层次进行划分，给不同的部门使用，实现不同的需求。

ODS原始数据层-ods-存放原始数据，直接加载原始日志、数据，数据保持原貌不变

DWD明细数据层-dwd_dim-对ods层数据进行清洗（去空值、脏数据、超过极限范围的数据）、脱敏

DWS服务数据层-dws-按天进行轻度汇总。一行信息代表一个主题对象一天的汇总行为

DWT数据主题层-dwt-对数据进行累计汇总。一行信息代表一个主题对象的累计行为

ADS数据应用层-ads-为各种统计报表提供数据

### 数仓建模

#### 关系建模

#### 维度建模

> 维度：就是分析事物的指标。
>
> 一维空间（线-长度）、二维空间（面-长度、宽度）、三维空间
>
> 维度表：将相关分析指标用一张表来表示
>
> 事实表：主要记录历史信息，可以保存大量的业务度量数据
>
> **选择业务处理过程 > 定义粒度 > 选择维度 > 确定事实**

##### 维度表

维度是维度建模的基础和灵魂。在维度建模中，将度量称为“事实” ， 将环境描述为“维度”。维度表包含了事实表中指定属性的相关详细信息，最常用的维度表有日期维度、城市维度等。

###### 维度表设计原则

维度的作用一般是查询约束、分类汇总以及排序等，我们在进行维度表设计时，应当提前考虑：

###### **（1）维度属性尽量丰富，为数据使用打下基础**

比如淘宝商品维度有近百个维度属性，为下游的数据统计、分析、探查提供了良好的基础。

###### **（2）给出详实的、富有意义的文字描述**

属性不应该是编码，而应该是真正的文字。在间里巴巴维度建模中， 一般是编码和文字同时存在，比如商品维度中的商品 ID 和商品标题、 类目 ID 和 类目名称等。ID 一 般用于不同表之间的关联，而名称一般用 于报表标签

###### **（3）区分数值型属性和事实**

数值型宇段是作为事实还是维度属性，可以参考字段的一般用途。如果通常用于查询约束条件或分组统计，则是作为维度属性;如果通常 用于参与度量的计算， 则是作为事实。比如商品价格，可以用于查询约 束条件或统计价格区间 的商品数量，此时是作为维度属性使用的;也可 以用于统计某类目 下商品的平均价格，此时是作为事实使用的。另外， 如果数值型字段是离散值，则作为维度属性存在的可能性较大;如果数 值型宇段是连续值 ，则作为度量存在的可能性较大，但并不绝对，需要 同时参考宇段的具体用途。

###### **（4）沉淀出通用的维度属性，为建立一致性维度做好铺垫**

有些维度属性获取需要进行比较复杂的逻辑处理，有些需要通过多表关联得到，或者通过单表 的不同宇段混合处理得到，或者通过对单表 的某个字段进行解析得到。此时，需要将尽可能多的通用的维度属性进 行沉淀。一方 面，可以提高下游使用的方便性，减少复杂度;另一方面，可以避免下游使用解析时由于各自逻辑不同而导致口径不 一致。

###### **（5）退化维度（Degenerate Dimension）**

在维度类型中，有一种重要的维度称作为退化维度。这种维度指的是直接把一些简单的维度放在事实表中。退化维度是维度建模领域中的一个非常重要的概念，它对理解维度建模有着非常重要的作用，退化维度一般在分析中可以用来做分组使用。

###### **（6）缓慢变化维（Slowly Changing Dimensions）**

维度的属性并不是始终不变的，它会随着时间的流逝发生缓慢的变化，这种随时间发生变化的维度我们一般称之为缓慢变化维（SCD），**缓慢变化维一般使用代理健作为维度表的主健。**

**TYPE1 直接覆盖原值**

对于某些维度属性，**值不会发生变化，因此可以保留初始值**。此方法什么也不做，因此称为 type0。例如日期维度的大多数属性，值都不会发生变化，如月份、季度、是否节假日等属性。适用于：不看历史数据，简单粗暴

**TYPE2 拉链表**

在维度表中增加新的一行，新行中采用新的属性值。**此方式及其变种是处理缓慢变化维的主要技术**。这种方法需要维度主键更具一般性，若仅采用自然键/持久键，则会出现多行描述同一成员的情况，即主键不唯一。

需要在维度行再增加三列：有效日期、截止日期、行标识（可选）。

在旧的一行数据增加关链时间（end_date），新的一行数据增加**开链时间**和**关链时间，**多条数据加起来是一个完整的时间周期。

**TYPE3 增加属性列**

该方法在维度表中增加新的一列以保存原来的属性值，新的属性值以 type1 的方式重写主属性。这种变化有时被称为替换现实 (alternate reality)。

**用户可利用当前值或替换现实对事实数据进行分组或者过滤**。这种方法用不同的字段保存变化痕迹。但是这种方法不能像第二种方法一样保存所有变化记录,除非每次变化都新增字段，但是我们不能无限增加字段来满足属性值的变化；因此对于只增加一列的情况，它只能保存两次变化记录，适用于变化不超过两次的维度，但是很难保证维度变化不超过两次，因此这种方法在实际中并不太常用。

以商品维度为例：

**维度属性值变化前：**

商品键	品类

SPU001	科技

**维度属性值变化后：**

商品键	当前品类	原先品类

SPU001	教育 科技

**type4: 增加微型维度**

当某维表是一个大型维度表，采用方式2时，如果某些维度属性变化相对较快，这将导致维度表中的数据量增长过快，带来过多的数据冗余存储，该维表变得越来越大，导致存储压力和性能压力，严重影响对历史数据的查询、分析效率。

此时引入微型维度是一个不错的选择，将某些维度属性从该大型维表中抽离出来，单独构建微型维度。

**微型维度(mini-dimension)是指将那些变化频率快的属性从原有的维度表中分离出来单独组合成一个或多个新的维度**。可以在原事实表中增加新的外关键字以建立事实表与微型维度表的联系，即直接将微型维度表作为原事实表的维度表使用，也可以将微型维度表设计为原维度表的维度,这样就将原有的星型模型扩展为雪花模型.此时对快变维度的处理就变成了对微型维度的处理.当维度属性值发生变化时,其影响范围仅仅局限于微型维度表,也可以有效降低数据的冗余存储现象。

频繁变化的维度属性也不利于分析操作的执行。



维度建模的基础上分三种模型：星型模型、雪花模型、星座模型

**雪花模型：**在星型模型的基础上，维度表上又关联了其他维度表。这种模型维护成本高，性能方面也较差，所以一般不建议使用。尤其是基于hadoop体系构建数仓，减少join就是减少shuffle，性能差距会很大。比较靠近3NF，单数无法完全遵守，因为遵循3NF的性能成本太高

**星型模型：**星型模型主要是维表和事实表，以事实 表为中心，所有维度直接关联在事实表上，呈星型分布。与雪花模型的区别主要在于维度的层级，标准的星型模型维度只有一层，而雪花模型可能会涉及多级

> 星型模型可以理解为，一个事实表关联多个维度表，雪花模型可以理解为一个事实表关联多个维度表，维度表再关联维度表。

**星座模型**

星座模型，是对星型模型的扩展延伸，多张事实表共享维度表。

星座模型是很多数据仓库的常态，因为很多数据仓库都是多个事实表的。所以星座模型只反映是否有多个事实表，他们之间是否共享一些维度表。