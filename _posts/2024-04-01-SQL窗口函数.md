---
layout: post
title: SQLçª—å£å‡½æ•°
tags: [SQL]
categories: Demo
excerpt_separator: <!--more-->
---

çª—å£å‡½æ•°ï¼ˆOLAP,è”æœºåˆ†æå¤„ç†ï¼‰å‡½æ•°ï¼Œå¯ä»¥å¯¹æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œå¤æ‚åˆ†æã€‚ğŸ‘Œ

<!--more-->

# SQLçª—å£å‡½æ•°

ä¸“ç”¨çª—å£å‡½æ•°ï¼šrank(), dense_rank(), row_number()

æ±‡æ€»å‡½æ•°ï¼šsum(), avg(), count(), max(), min()

ä¸€èˆ¬ç”¨æ³•ï¼š

```sql
<çª—å£å‡½æ•°> over (partition by <åˆ†ç»„>  order by <æ’åº> )
```

rank() è€ƒè™‘å¹¶æ’æ’åï¼Œåºå·ä¸è¿ç»­

dense_rank() è€ƒè™‘å¹¶åˆ—æ’åï¼Œæ’ååºå·è¿ç»­

row_number() ä¸è€ƒè™‘å¹¶åˆ—æ’å

## çª—å£å‡½æ•°å¸¸è§é—®é¢˜

#### æ’åé—®é¢˜

```sql
select *, row_number() over( partition by <åˆ†ç»„>  order by <è¦æ’åºçš„åˆ—>) as <æ’å>
from <è¡¨>
```

å¦‚æœä¸åˆ†ç»„ï¼Œåªéœ€è¦å¯¹æ•´ä¸ªè¡¨çš„æŸä¸€åˆ—è¿›è¡Œæ’åï¼Œå¯ä»¥çœç•¥partition byè¿™éƒ¨åˆ†ã€‚

#### Top N

```sql
select *, 
from
    (select *, row_number() over( partition by <åˆ†ç»„> order by <æ’åº> ) as <æ’å>
	from <è¡¨> 
)as a
where <æ’å> <= N
```

éœ€è¦åšä¸€ä¸ªå­æŸ¥è¯¢ï¼Œç„¶åå†å»ç”¨whereå»ç­›é€‰

å‰ç™¾åˆ†ä¹‹N

```sql
select å­¦å·, ç­çº§, æˆç»© 
from
    (select *, percent_rank() over(partition by ç­çº§ order by æˆç»© desc) as <æ’å>
	from æˆç»©è¡¨ 
)as a
where <æ’å> <= 0.4
```

#### ç´¯è®¡é—®é¢˜

è®¾ç½®ç§»åŠ¨çª—å£

```sql
<çª—å£å‡½æ•°> over (partition by <åˆ†ç»„>  order by <æ’åº>  rows between <èµ·å§‹è¡Œ> and <ç»ˆæ­¢è¡Œ>)
```

â€¢ n precedingï¼šå½“å‰è¡Œçš„å‰nè¡Œã€‚
â€¢ n followingï¼šå½“å‰è¡Œçš„ånè¡Œã€‚
â€¢ current rowï¼šå½“å‰è¡Œã€‚
â€¢ unbounded precedingï¼šç¬¬1è¡Œã€‚
â€¢ unbounded followingï¼šæœ€å1è¡Œã€‚

#### æ¯ç»„å†…æ¯”è¾ƒé—®é¢˜

ä¾‹å¦‚éœ€è¦æ‰¾æ¯ç»„å¤§äºå¹³å‡å€¼çš„ï¼Œéœ€è¦å…ˆè®¡ç®—æ¯ç»„å†…çš„å¹³å‡å€¼

```sql
select *, avg(æˆç»©) over(partition by ç§‘ç›®) as å¹³å‡æˆç»©
from æˆç»©è¡¨
```

ç„¶åè®¡ç®—æ¯ç§‘æˆç»©å¤§äºå¹³å‡æˆç»©çš„å§“å

```sql
select ç§‘ç›®, å§“å
from (
    select *, avg(æˆç»©) over(partition by ç§‘ç›®) as å¹³å‡æˆç»©
    from æˆç»©è¡¨
) as a
where æˆç»© > å¹³å‡æˆç»©
```

#### è¿ç»­é—®é¢˜

ä½¿ç”¨åç§»çª—å£å‡½æ•°lead(), lag()è§£å†³

â€¢ å‘ä¸Šåç§»çª—å£å‡½æ•°lead()ï¼šå–å‡ºæ‰€åœ¨åˆ—å‘ä¸ŠNè¡Œçš„æ•°æ®ï¼Œä½œä¸ºç‹¬ç«‹çš„åˆ—ã€‚
â€¢ å‘ä¸‹åç§»çª—å£å‡½æ•°lag()ï¼šå–å‡ºæ‰€åœ¨åˆ—å‘ä¸‹Nè¡Œçš„æ•°æ®ï¼Œä½œä¸ºç‹¬ç«‹çš„åˆ—ã€‚

è¿ç»­å‡ºç°å››æ¬¡ä¸ºä¾‹ï¼š

```sql
select distinct <åˆ—>
from(
	select <åˆ—>,
    lead(<åˆ—>, 1) over(partition by <åˆ†ç»„>  order by <æ’åº>) as <åˆ—1>
    lead(<åˆ—>, 2) over(partition by <åˆ†ç»„>  order by <æ’åº>) as <åˆ—2>
    lead(<åˆ—>, 3) over(partition by <åˆ†ç»„>  order by <æ’åº>) as <åˆ—3>
    from <è¡¨>
) as a
where (<åˆ—> = <åˆ—1> and <åˆ—> = <åˆ—2> and <åˆ—> = <åˆ—3>)
```

